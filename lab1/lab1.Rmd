---
title: "Developing a prediction model for car mileage"
subtitle: "Report for Lab 1 in Linear Statistical Models (MVE190)"
author: "Joel Goop"
date: "November 9, 2016"
output: 
  bookdown::pdf_document2:
    number_sections: true
    includes:
      in_header: header.tex
documentclass: article
classoption: a4
geometry: margin=3cm
toc: false
---

```{r setup, include=FALSE}
library(ggplot2)
knitr::opts_chunk$set(echo = TRUE)

load('Lab1data.RData')
load('itest.RData')
Auto.Train<-newAuto[-itest,]
Auto.Test<-newAuto[itest,]

source('funcs.R')
```

# Introduction

The objective of this lab is to model the relationship between the selling price and the floor area of houses based on the `house` dataset. To ascertain the validity of the model, we also investigate the data to ensure that the 5 basic assumptions of 

Table \@ref(tab:datasummary)

```{r datasummary,echo=FALSE}
summarydf<-sapply(Auto.Train,tabled.summary)
knitr::kable(summarydf,
             caption='Summary statistics for the sampled part of the `Auto` dataset',
             digits=0,
             booktabs=TRUE)
real.rows<-dim(newAuto[!apply(newAuto, 1, function(x) all(is.na(x))),])[1]
tr.rows<-dim(Auto.Train[!apply(Auto.Train, 1, function(x) all(is.na(x))),])[1]
te.rows<-dim(Auto.Test[!apply(Auto.Test, 1, function(x) all(is.na(x))),])[1]
```

# Methods and data

The primary method used is ordinary least squares fitting of a linear regression model to predict the mileage of a car based on 6 other properties. A dataset with `r real.rows` datapoints (after removing `r dim(newAuto)[1]-real.rows` rows where all values are missing) is split into training and test sets. The training set contains `r tr.rows` data points and the test set contains `r te.rows`.  Missing values are imputed using regression models based on related variables in the dataset. The data is inspected and appropriate variable transformations are applied.

The focus of this report is on model selection, which is performed both with an exhaustive search of all possible combination of variables and with backward elimination removing one variable at a time.

The analysis is implemented in `R` using mainly the standard library, combined with the `leaps` package to simplify model selection.

# Results and discussion


## Imputation

If we only consider data points where no values are missing, we have to sacrifice \SI{`r round((1-sum(complete.cases(newAuto))/real.rows),3)*100`}{\percent} of the data. Imputation of the missing values for each variable is done using regression on other variables according to the following:

- `weight` is imputed using regression on `displacement`, `acceleration`, and `horsepower`.
- `year` is imputed using regression on `weight` and `horsepower`.
- `displacement`
- `acceleration`
- `cylinders`
- `horsepower`

## Variable transformations

```{r initialdatatransform, echo=FALSE}
trauto <- Auto.Train[complete.cases(Auto.Train),]
# Transform 1/y
trauto$mpg <- 1/trauto$mpg
# Rename to gpm
names(trauto)[names(trauto)=="mpg"] <- "gpm"
```

Pairwise scatter plots of the data revealed several strong connections between the variables and the mileage, but also internally between variables. Based on the shape of the relation between mileage and several other variables an inverse transform was applied, converting mileage (miles per gallon) to fuel consumption (gallons per mile). In  Figure \@ref(fig:initialscatter), the mileage and fuel consumption is plotted against weight. After the transformation the relationship seems sufficiently linear to apply regression.

```{r initialscatter,echo=FALSE,fig.cap='Mileage against weight (left) and inverse mileage (or fuel consumption) against weight (right). After the inverse transformation the relationship seems more or less linear.',fig.height=3.5,fig.width=7}

p1<-(ggplot(trauto, aes(x=weight, y=1/gpm))
      +geom_point(shape=21,fill='white')
      +labs(x="Weight",y="Miles per gallon"))
p2<-(ggplot(trauto, aes(x=weight, y=gpm))
      +geom_point(shape=21,fill='white')
      +labs(x="Weight",y="Gallons per mile"))

multiplot(p1,p2,cols=2)
```

## Model selection 


# Conclusion
